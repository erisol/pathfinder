<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../style/reset.css" />
<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
<title>Edge Maker</title>
</head>

<body>
<div style="width: 2482px; height: 1092px;">
	<div style="float:left; width: 300px; height: 1092px;">
    	<div style="float:left;position:fixed; width: 300px; overflow: auto; height: 100%; border-right: 3px solid #000; text-align: center; background-color: white">
        	<br />
        	<strong>Current Node Information:</strong><br />
        	<table width="295" border="0" cellspacing="0" cellpadding="0">
            	<tr>
                	<td>Room:</td>
                    <td><span id="curNodeRoom"> </span></td>
                </tr>
        		<tr>
                	<td>X-Coords:</td>
                	<td><span id="curNodeX"> </span></td>
                </tr>
        		<tr>
                	<td>Y-Coords:</td>
                	<td><span id="curNodeY"> </span></td>
                </tr>
        		<tr>
                	<td>Floor:</td>
                	<td><span id="curNodeFloor"> </span></td>
                </tr>
            </table>
            <br />
        	<table width="295" border="0" cellspacing="0" cellpadding="0">
        		<tr>
  		 			<td></td>
  					<td><input name="createEdge" type="button" value=" Make New Edge " onclick="makeNewEdge()" /></td>
  				</tr>
        	</table>
        	<br />
        	Create Edge Between:
        	<form name="edgeStore">
        		<table width="295" border="0" cellspacing="0" cellpadding="0">
  					<tr>
    					<td><Strong>Node 1</Strong></td>
    					<td><input name="node1Id" type="hidden" value=""></td>
  					</tr>
                    <tr>
    					<td>Room</td>
    					<td><input name="node1Room" type="text" maxlength="8" value="" readonly/></td>
  					</tr>
                    <tr>
    					<td>X-Coords</td>
    					<td><input name="node1X" type="text" maxlength="5" value="" readonly/></td>
  					</tr>
                    <tr>
    					<td>Y-Coords:</td>
    					<td><input name="node1Y" type="text" maxlength="5" value="" readonly/></td>
  					</tr>
                    <tr>
    					<td>Floor</td>
    					<td><input name="node1Floor" type="text" maxlength="4" value="" readonly/></td>
  					</tr>
  					<tr><td></td><td><input type="button" value=" Change Node 1" onclick="activate1()" /></td></tr>
				</table><br />
                <table width="295" border="0" cellspacing="0" cellpadding="0">
                    <tr>
    					<td><strong>Node 2</strong></td>
    					<td><input name="node2Id" type="hidden" value=""></td>
  					</tr>
                    <tr>
    					<td>Room</td>
    					<td><input name="node2Room" type="text" maxlength="8" value="" readonly/></td>
  					</tr>
                    <tr>
    					<td>X-Coords</td>
    					<td><input name="node2X" type="text" maxlength="5" value="" readonly/></td>
  					</tr>
                    <tr>
    					<td>Y-Coords</td>
    					<td><input name="node2Y" type="text" maxlength="5" value="" readonly/></td>
  					</tr>
                    <tr>
    					<td>Floor</td>
    					<td><input name="node2Floor" type="text" maxlength="4" value="" readonly/></td>
  					</tr>
   					<tr><td></td><td><input type="button" value=" Change Node 2" onclick="activate2()" /></td></tr>
                    </table><br />
                    <table width="295" border="0" cellspacing="0" cellpadding="0">
   					<tr>
    					<td>Type:</td>
                        <td><select id="edgeType" name="edgeType" style="width: 153px">
                            <option value="gang">Gang</option>
                            <option value="trapp">Trapp</option>
                            <option value="heis">Heis</option>
							</select>
    					</td>
  					</tr>
            		<tr>
    					<td>Change Floor:</td>
    					<td><select id="fVal" name="fval" style="Width:153px" onchange="checkSelectedFloor()">
    						<option value="1" selected>1</option>
    						<option value="2">2</option>
                       		<option value="3">3</option>
                       	 	<option value="4">4</option>
                       		<option value="5">5</option>
						</td>
  					</tr>
                </table><br />
                <input name="newEdge" type="button" value=" Add Edge " onclick="addEdge()" />
			</form>
			<br />
            Edges added:
            <ol id="theEdges"><br /></ol>
            <br /><br />
			<input type="button" name="saveEdges" id="saveEdges" value=" Save edges to file " onclick="saveEdges()"/>
		</div>
	</div>
	<div id="canvasFloat" style="float:left;">
	<canvas id="makeEdgeCanvas" width="2182" height="1092">
    <script> 
 		$(document).ready(function(){
			checkSelectedFloor();
  		});
	</script>
</div>  
<script>
	Array.prototype.checkId = function(value){
		for(var indx = 0; indx < this.length; indx++){
			var testArray = this[indx].split(",");
			if(testArray[0] == value){
				return indx;
			}
		}
		return -1;
	}
	var oldFloor = 1;
	nextId = 0;
	oldSaved = true;
	var edges = new Array();
	var change1 = false;
	var change2 = false;
	array1Floor = ["0,gang,81,189,1", "1,gang,67,217,1", "2,gang,232,252,1", "3,gang,169,308,1"];
	array2Floor = ["4,gang,281,189,2", "5,gang,267,217,2", "6,gang,432,252,2", "7,gang,369,308,2"];
	array3Floor = ["8,gang,381,189,3", "9,gang,367,217,3", "10,gang,532,252,3", "11,gang,469,308,3"];
	array4Floor = ["12,gang,300,189,4", "13,gang,300,217,4", "14,gang,632,308,4", "15,gang,544,308,4"];
	array5Floor = ["16,gang,581,189,5", "17,gang,567,217,5", "18,gang,732,252,5", "19,gang,669,308,5"];
	
	function drawOldNode(x, y, oldId){
		var getCanvas = document.getElementById("canvasFloat");
		var node = document.createElement("div");
		var nodeId = oldId;
		node.setAttribute("id", nodeId);
		node.style.height = "8px";
		node.style.width = "8px";
		node.style.backgroundColor = "#FF0000";
		node.style.cssFloat ="left";
		node.style.left = (parseInt(x)+296)+"px";
		node.style.top = parseInt(y)-4+"px";
		node.style.position = "absolute";
		node.style.display = "visible";
		node.onmouseover = function(){
			showtext(nodeId);
			document.getElementById(nodeId).style.backgroundColor = "yellow";
		}
		node.onmouseout = function(){
			document.getElementById(nodeId).style.backgroundColor = "red";	
		}
		node.onclick = function(){
			changeText(nodeId);
		}
		getCanvas.appendChild(node);
	}
	
	function showtext(nodeId){
		var messageRoom = document.getElementById("curNodeRoom");
		var messageX = document.getElementById("curNodeX");
		var messageY = document.getElementById("curNodeY");
		var messageFloor = document.getElementById("curNodeFloor");
		var nodeArray = getCurrentArray()[getCurrentArray().checkId(nodeId)].split(",");
		messageX.innerHTML = nodeArray[2];
		messageY.innerHTML = nodeArray[3];
		messageFloor.innerHTML = nodeArray[4];
		messageRoom.innerHTML = nodeArray[1];
	}
	
	function changeText(nodeId){
		var nodeArray = getCurrentArray()[getCurrentArray().checkId(nodeId)].split(",");
		if(change1 && document.getElementsByName("node2Id")[0].value !== nodeArray[0]){
			document.getElementsByName("node1Id")[0].value = nodeArray[0];
			document.getElementsByName("node1Room")[0].value = nodeArray[1];
			document.getElementsByName("node1X")[0].value = nodeArray[2];
			document.getElementsByName("node1Y")[0].value = nodeArray[3];
			document.getElementsByName("node1Floor")[0].value = nodeArray[4];
			change1 = false;
			oldSaved = false;
		}else if(change2 && document.getElementsByName("node1Id")[0].value !== nodeArray[0]){
			document.getElementsByName("node2Id")[0].value = nodeArray[0];
			document.getElementsByName("node2Room")[0].value = nodeArray[1];
			document.getElementsByName("node2X")[0].value = nodeArray[2];
			document.getElementsByName("node2Y")[0].value = nodeArray[3];
			document.getElementsByName("node2Floor")[0].value = nodeArray[4];
			change2 = false;
			oldSaved = false;
		}else{
		}
	}
	function makeNewEdge(){
		activate1();
		activate2();
	}
	
	function activate1(){
		change1 = true;
	}
	
	function activate2(){
		change2 = true;
	
	}
	
	function checkEdgeFloor(type, node1floor, node2floor){
		if(node1floor !== node2floor && type === "gang"){
			alert("Du må endre edge type til Trapp eller Heis");
			return false;	
		}
		if(node1floor === node2floor && type !== "gang"){
			alert("Du må endre edge type til Gang");
			return false;	
		}
		return true;
	}
	function drawLine(x1, y1, x2, y2, id){
		var drawinfo = finddegrees(x1,y1,x2,y2);
		var degree = drawinfo[0];
		var getCanvas = document.getElementById("canvasFloat");
		var node = document.createElement("div");
		var nodeId = id;
		node.setAttribute("id", "line"+id);
		node.style.backgroundColor = "black";
		node.style.height = "1px";
		node.style.width = parseInt(Math.sqrt(Math.pow((x2-x1),2)+Math.pow((y2-y1),2)))+"px";
		node.style.top = parseInt(y1)+"px";
		node.style.position = "absolute";
		node.style.display = "visible";
		node.style.left = parseInt(x1)+parseInt(300)+"px";
		var x = (parseInt((Math.sqrt(Math.pow((x2-x1),2)+Math.pow((y2-y1),2)))/2)-drawinfo[1]);
		var y = drawinfo[2]*Math.sin((Math.PI/180)*degree);
		node.style.webkitTransform = "translateY("+y+"px) translateX("+x+"px) rotate("+degree+"deg)";
		node.style.msTransform = "rotate("+degree+"deg)"; /* IE 9 */
		node.style.transform = "rotate("+degree+"deg)"; /* Standard syntax */
		getCanvas.appendChild(node);
	}
	
	function finddegrees(x1,y1,x2,y2){
		x1 = parseInt(x1);
		x2 = parseInt(x2);
		y1= -parseInt(y1);
		y2= -parseInt(y2);
		if(x1 < x2 && y1 < y2){
			console.log("1");
			return [-(Math.atan(((y2-y1)/(x2-x1))))*(180/Math.PI),Math.sqrt(Math.pow((parseInt(y2-y1)/2),2) + Math.pow((Math.sqrt(Math.pow(parseInt(x2-x1),2)+Math.pow(parseInt(y2-y1),2)))/2,2)),0.5*Math.sqrt(Math.pow(x2-x1,2) + Math.pow(y2-y1,2))];
		}
		
		else if(x1 < x2 && y1 > y2){
			console.log("2");
			return [(Math.atan(((y1-y2)/(x2-x1))))*(180/Math.PI),Math.sqrt(Math.pow((parseInt(y2-y1)/2),2) + Math.pow((Math.sqrt(Math.pow(parseInt(x2-x1),2)+Math.pow(parseInt(y2-y1),2)))/2,2)),0.5*Math.sqrt(Math.pow(x2-x1,2) + Math.pow(y1-y2,2))];
		}
		
		else if(x1 > x2 && y1 < y2){
			console.log("3");
			return [-180+(Math.atan(((y2-y1)/(x1-x2))))*(180/Math.PI),Math.sqrt(Math.pow((parseInt(y2-y1)/2),2) + Math.pow((Math.sqrt(Math.pow(parseInt(x2-x1),2)+Math.pow(parseInt(y2-y1),2)))/2,2))+(x1-x2),0.5*Math.sqrt(Math.pow(x1-x2,2) + Math.pow(y2-y1,2))];
		}
		
		else if(x1 > x2 && y1 > y2){
			console.log("4");
			return [180-(Math.atan(((y1-y2)/(x1-x2))))*(180/Math.PI),Math.sqrt(Math.pow((parseInt(y2-y1)/2),2) + Math.pow((Math.sqrt(Math.pow(parseInt(x2-x1),2)+Math.pow(parseInt(y2-y1),2)))/2,2))+(x1-x2),0.5*Math.sqrt(Math.pow(x1-x2,2) + Math.pow(y2-y1,2))];
		}
		
		else if(x1===x2){
			if(y1 < y2){
				console.log("5");
				return [-90,y2-y1, (y2-y1)/2];	
			}
			
			else if(y1 > y2){
				return [90,y1-y2,(y1-y2)/2];
			}
			
		}
		
		else if(y1===y2){
			if(x1 < x2){
				return [0,(x2-x1)/2,0];
			}
			
			else if(x1 > x2){
				return [0,-(x2-x1)*1.5,0];
			}
		}
	}
	function addEdge(){
		var id1 = document.getElementsByName("node1Id")[0].value;
		var x1 = document.getElementsByName("node1X")[0].value;
		var y1 = document.getElementsByName("node1Y")[0].value;
		var floorVal1 = document.getElementsByName("node1Floor")[0].value;
		var id2 = document.getElementsByName("node2Id")[0].value;
		var x2 = document.getElementsByName("node2X")[0].value;
		var y2 = document.getElementsByName("node2Y")[0].value;
		var floorVal2 = document.getElementsByName("node2Floor")[0].value;
		var edgeType = document.getElementById("edgeType").value;
		if((id1 !== "") && (id2 !== "") && !oldSaved && checkEdgeFloor(edgeType, floorVal1, floorVal2)){
			var edge = id1 + "," + id2 + "," + edgeType;
			edges[edges.length] = edge;
			displayEdges();
			drawLine(x1,y1,x2,y2,nextId+1);
			nextId++;
			oldSaved = true;
		}
	}
	
	function displayEdges() {
		var displayId = nextId+1;
		addEdgeToList(displayId);
	}
	
	function addEdgeToList(displayId){
		var parentElement = document.getElementById("theEdges");
		var itemElementID = String("theEdges"+displayId);
		var itemElement = document.getElementById(itemElementID);
		var itemDisplayText = edges[displayId-1].toString();
   		var newList= document.createElement("li");
    	var newText = document.createTextNode(itemDisplayText);
		newList.setAttribute("id", itemElementID);
    	newList.appendChild(newText);
		newList.innerHTML += " <a href='#' onclick='removeEdge("+displayId+")'>Remove this</a>";
   		parentElement.appendChild(newList);
	}
	
	function removeEdge(id){
		var nodesDisplayed = document.getElementById("theEdges"+id);
		nodesDisplayed.remove(id);
		edges.splice(id, 1);
	}
	
	function removeDraw(nodeid){
		removeDrawnNode = "#"+nodeid;
		$(removeDrawnNode).remove();
	}
	
	function changeNodes(){
		var oldArray = getOldArray();
		var newArray = getCurrentArray();
		for(var idx = 0; idx < oldArray.length; idx++){
			var currentNode = oldArray[idx].split(",");
			removeDraw(parseInt(currentNode[0]));	
		}
		for(var idx = 0; idx < newArray.length; idx++){
			node = newArray[idx].split(",");
			drawOldNode(node[2],node[3],node[0]);
		}
	}
	function getOldArray(){
		switch (oldFloor) {
			case 1:
				return array1Floor;
				break;
			case 2:
				return array2Floor;
				break;
			case 3:
				return array3Floor;
				break;
			case 4:
				return array4Floor;
				break;
			case 5:
				return array5Floor;
				break;	
		}
	}
	function getCurrentArray(){
		var selectedFloor = parseInt(document.getElementById("fVal").value);
		switch (selectedFloor) {
			case 1:
				return array1Floor;
				break;
			case 2:
				return array2Floor;
				break;
			case 3:
				return array3Floor;
				break;
			case 4:
				return array4Floor;
				break;
			case 5:
				return array5Floor;
				break;	
		}
	}
	function checkSelectedFloor() {
		var theCanvas = document.getElementById("makeEdgeCanvas");
		var selectedFloor = parseInt(document.getElementById("fVal").value);
		switch (selectedFloor) {
			case 1:
				changeNodes();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_1etg.jpg)");
				oldFloor = 1;
				break;
			case 2:
				changeNodes();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_2etg.jpg)");
				oldFloor = 2;
				break;
			case 3:
				changeNodes();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_3etg.jpg)");
				oldFloor = 3;
				break;
			case 4:
				changeNodes();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_4etg.jpg)");
				oldFloor = 4;
				break;
			case 5:
				changeNodes();
				theCanvas.setAttribute("style", "background: url(../kart/kart_Kjølv_Egelands_hus_5etg.jpg)");
				oldFloor = 5;
				break;	
		}
	}
	
	function saveEdge(){
		
	}
</script>
</body>
</html>
