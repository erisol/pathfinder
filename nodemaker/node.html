<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../style/reset.css" />
<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
<title>Create nodes</title>
</head>
<body>
<div style="width: 2486px; height: 1092px;">

        <div style="float:left; width: 300px; height: 1092px; border-right: 3px solid #000; text-align: center;">
        
        <p><strong>Create nodes</strong>
        <br />
        </p>
        <p><br />
        Click on the map to the right to add a node.
        <br /><br />
        Coordinates:
        <span id="mouseCoords"></span>
        <br /><br />
        <table width="295" border="0" cellspacing="0" cellpadding="0">
        	<tr>
  		 		<td></td>
  				<td><input name="createNode" type="button" value=" Make New Node " onclick="drawNode()" /></td>
  			</tr>
        </table>
        <br /><br />
        Node information:
        </p>
        <form name="storeCoords">
        <table width="295" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td>X:</td>
    <td><input name="xVal" type="text" maxlength="4" value="" /></td>
  </tr>
  <tr>
    <td>Y:</td>
    <td><input name="yVal" type="text" maxlength="4" value="" /></td>
  </tr>
  <tr>
    <td>Floor:</td>
    <td><select id="fVal" name="fval" style="Width:153px" onchange="checkSelectedFloor()">
    <option value="1" selected>1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option></td>
  </tr>
  <tr>
    <td>Room:</td>
    <td><select id="roomnr" name="roomnr" style="width: 153px">
  <option value="gang">Gang</option>
	<script> 
 		$(document).ready(function(){
			checkSelectedFloor();
 	 		addrooms();
  		});
	</script>
</select>
    </td>
  </tr>
  <tr>
    <td></td>
    <td><input name="newNode" type="button" value=" Add node " onclick="addNode()" /></td>
  </tr>
</table>
	</form>
    <br /><br />
    
    Nodes added:
    <ol id="theNodes"><br /></ol>
    <br /><br />
     <input type="button" name="SaveNodes" id="SaveNodes" value=" Save nodes to file " onclick="saveNodes();"/>
    
        </div>

        <div id="canvasFloat" style="float:left;">
        <canvas id="makeNodeCanvas" width="2182" height="1092">
<script>

	function checkSelectedFloor() {
		var theCanvas = document.getElementById("makeNodeCanvas");
		var selectedFloor = parseInt(document.getElementById("fVal").value);
		switch (selectedFloor) {
			case 1:
				//clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_1etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;
			case 2:
				//clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_2etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;
			case 3:
				//clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_3etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;
			case 4:
				//clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_4etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;
			case 5:
				//clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_Kjølv_Egelands_hus_5etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;	
		}
	}
	
	function getMousePos(canvas, evt) {
    	var rect = canvas.getBoundingClientRect();
        return {
        	x: evt.clientX - rect.left,
          	y: evt.clientY - rect.top
        };
    }
    var canvas = document.getElementById('makeNodeCanvas');
    var context = canvas.getContext('2d');
	  
	function writeMessage(message) {
		var messageCoords = document.getElementById("mouseCoords");
		messageCoords.innerHTML = message; 
	}
	
    canvas.addEventListener('mousemove', function(evt) {
    	var mousePos = getMousePos(canvas, evt);
        var message = mousePos.x + ',' + mousePos.y;
    	writeMessage(message);
    }, false);
	
	var array5Floor = [];
	var nextId = 0;
	function saveNodes(){
		if (gridArray.length == 0) {
			console.log("the array is empty. nothing will be stored");
		} else {
			console.log(gridArray);
			writeGridToFile(gridArray);
		}	
	}
	  
    function writeGridToFile(data){
		var file = String(floorNodeListArray[selectedFloor]);
    	var xmlhttp;
    	if(window.XMLHttpRequest) {
    		xmlhttp=new XMLHttpRequest();
		}else {
    		xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
		}
    	xmlhttp.open("GET","gridOperations.php?data="+data+"&file="+file,true);
    	xmlhttp.send();
	}
	var createExistingXgrid = new Array();
	var createExistingYgrid = new Array();
	var floorListArray = ["","grids/ke/1.txt", "grids/ke/2.txt", "grids/ke/3.txt", "grids/ke/4.txt", "grids/ke/5.txt"];
	function loadSelectedFloorGrid(n) {
		jQuery.ajax({
		url: floorListArray[n],
		dataType: 'text',
		type: "GET",
		cache: false,
  		success: function(data) {
    		var newArray = data.split(",");
			for (var i = 0; i<=newArray.length; i+2) {
				if (newArray[i] == 0 && newArray[i+1] >= 0) {
					createExistingXgrid(newArray[i+1]);
					console.log("created 1 x grid: "+newArray[i+1]);
				} else if (newArray[i] >= 0 && newArray[i+1] == 0) {
					createExistingYgrid(newArray[i]);
					console.log("created 1 y grid: "+newArray[i]);
				} else {
					console.log("all grids were filled. no further grids were added");
				}
			}           
  		}
		});
	}
	
	function drawNode(){
		var getCanvas = document.getElementById("canvasFloat");
		var node = document.createElement("div");
		var nodeId = String("nodediv"+nextId);
		node.setAttribute("id", nodeId);
		node.style.height = "6px";
		node.style.width = "6px";
		node.style.backgroundColor = "#FF0000";
		node.style.cssFloat ="left";
		node.style.left ="300";
		node.style.top = "0";
		node.style.position = "absolute";
		node.style.display = "visible";
		getCanvas.appendChild(node);
		moveNode();
	}
	
	function moveNode() {
		var newNode = ("#nodediv"+nextId)
		var runningBoolean = true;
			$("#canvasFloat").mousemove(function(e){
				if (runningBoolean) {
				$mouseX = e.pageX-3;
				$mouseY = e.pageY-3; 
				$(newNode).css({top:$mouseY});
				$(newNode).css({left:$mouseX});
				} else {
					return;
				}
			});
			$(newNode).click(function(e) {
				var xvalue = document.getElementsByName("xVal");
				var yvalue = document.getElementsByName("yVal");
				var mousePos = getMousePos(canvas, e);
				xvalue[0].value = mousePos.x;
				yvalue[0].value = mousePos.y;
				runningBoolean = false;
		});
	}
	
	function addNode() {
		var xvalue = document.getElementsByName("xVal")[0].value;
		var yvalue = document.getElementsByName("yVal")[0].value;
		var fvalue = document.getElementById("fVal").value;
		var roomid = document.getElementById("roomnr").value;
		if(xvalue !== "" || yvalue !== ""){
			array5Floor[nextId] = roomid + "," + xvalue +","+ yvalue +","+ fvalue;
			displayNodes();
			nextId++;
		}
		 document.getElementById("roomnr").selectedIndex = 0;
	}
	
	function getFloorArray(floor){
		var file = ReadFromfile("nodes"+floor);
		return parseFileToArray(file); 
	}
	function getrooms(){
		var strins = "E202,E404,E503,E501";
		return strins.split(",");
	}
	function addrooms(){
		var listofrooms = getrooms();
		var currentrooms = document.getElementById("roomnr");
		for(var indx = 0; indx < listofrooms.length; indx++){
			var newroom = document.createElement('option');
    		newroom.value = listofrooms[indx];
    		newroom.innerHTML = listofrooms[indx];
    		currentrooms.appendChild(newroom);
		}
	}
	function findPrevId(){
		var idVal = 0;
		for(var idx = 0; idx < 5; idx++){
			var list = getFloorArray();
			for(var elems = 0; elems < list.length; elems++){
				idVal++;
			}
		}
		return idVal;
	}
	  
	function currentIdVal(){
		if(idVal == null){
			var idVal = findPrevId()
		}
		return this.idVal++;  
	}
	  
	function removedraw(nodeid){
		console.log(nodeid);
		removeDrawNode = "#nodediv"+nodeid;
		$(removeDrawNode).remove();
	}
	
	function removeNode(nodeid){
		removedraw(nodeid-1);
		var nodesDisplayed = document.getElementById("theNodes"+nodeid);
		nodesDisplayed.remove(nodeid);
		array5Floor.splice(nodeid-1,1);
	}
	function snapToGrid(x, y){
		
	}
	
	var displayedNodes = [];
	function displayNodes() {
		var displayId = nextId+1;
		var parentElement = document.getElementById("theNodes");
		var itemElementID = String("theNodes"+displayId);
		var itemElement = document.getElementById(itemElementID);
		var itemDisplayText = array5Floor[nextId].toString();
   		var newList= document.createElement("li");
    	var newText = document.createTextNode(itemDisplayText);
		newList.setAttribute("id", itemElementID);
    	newList.appendChild(newText);
		newList.innerHTML += " <a href='#' onclick='removeNode("+displayId+")'>Remove this</a>";
   		parentElement.appendChild(newList);
	}
</script>
	</div>
</div>
</body>
</html>
