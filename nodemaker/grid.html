<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="no-cache">
<meta http-equiv="Expires" content="-1">
<meta http-equiv="Cache-Control" content="no-cache">
<link rel="stylesheet" type="text/css" href="../style/reset.css" />
<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
<title>Create grid</title>
</head>
<body>
<div style="width: 2486px; height: 1092px;">

        <div style="float:left; width: 300px; height: 1092px; border-right: 3px solid #000; text-align: center;">
        
        <p><strong>Create grid (Kjølv Egeland)</strong>        </p>
        <p><br />
        </p>
        <p>Choose floor:</p>
        <p>&nbsp;</p>
        <p>
          <label>
            <input type="radio" name="floors" value="1" id="floor1" onclick="checkSelectedFloor();"/>
            (1)</label>
          <br />
          <label>
            <input type="radio" name="floors" value="2" id="floor2" onclick="checkSelectedFloor();" />
            (2)</label>
          <br />
          <label>
            <input type="radio" name="floors" value="3" id="floor3" onclick="checkSelectedFloor();" />
            (3)</label>
          <br />
          <label>
            <input type="radio" name="floors" value="4" id="floor4" onclick="checkSelectedFloor();" />
            (4)</label>
          <br />
          <label>
            <input type="radio" name="floors" value="5" id="floor5" onclick="checkSelectedFloor();" />
            (5)</label>
          <br /><br />
          <input type="button" name="cGrids" id="cGrids" value="Clear all grids" onclick="clearGrids();"/>
          <br /><br /><br />
          Choose grid</p>
        <p>&nbsp;</p>
        <p>
          <input type="button" name="xGrid" id="xGrid" value="X grid" onclick="createXgrid();" /> 
          <input type="button" name="yGrid" id="yGrid" value="Y grid" onclick="createYgrid();"/><br /><br /><br />
  
          Coordinates:
          <span id="mouseCoords"></span>
          <br /><br /><br /><br />
          Created grids:
         <ol id="createdGridsDisplay">
         </ol>
         <!--<input type="button" name="addTheGrids2" id="addTheGrids2" value="Load grid" onclick="loadSelectedFloorGrid(5);"/>-->
         <br /><br />
         <input type="button" name="addTheGrids" id="addTheGrids" value="Save current grids to the selected floor" onclick="saveGrids();"/>
         </p>
        </div>
        <div id="canvasFloat" style="float:left;" width="2200" height="1110">
        <canvas id="makeGridCanvas" width="2182" height="1092">
        </canvas>
            <script>
			
			var selectedFloor = $('input[name="floors"]:checked').val();
			var floorListArray = ["","grids/ke/1.txt", "grids/ke/2.txt", "grids/ke/3.txt", "grids/ke/4.txt", "grids/ke/5.txt"];
			
			var nextGrid = 0;
			var gridArray = [];
	  		var gridArrayIndex = 0;
			var deletedGrids = [];
			
      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: parseInt(evt.clientX - rect.left),
          y: parseInt(evt.clientY - rect.top)
        };
      }
      var canvas = document.getElementById('makeGridCanvas');
      var context = canvas.getContext('2d');
	  
	  function writeMessage(message) {
		  var messageCoords = document.getElementById("mouseCoords");
		  messageCoords.innerHTML = message;
	  }
	
	  
      canvas.addEventListener('mousemove', function(evt) {
        var mousePos = getMousePos(canvas, evt);
        var message = mousePos.x + ',' + mousePos.y;
        writeMessage(message);
      }, false);
	  
	  
	  function createXgrid() {
		  var getCanvas = document.getElementById("canvasFloat");
		  var newXgrid = document.createElement("div");
		  var gridId = String("canvasGrid"+nextGrid);
		  newXgrid.setAttribute("id", gridId);
		  newXgrid.style.height = "1px";
		  newXgrid.style.width = "2192px";
		  newXgrid.style.cssFloat ="left";
		  newXgrid.style.backgroundColor = "#FF0000";
		  newXgrid.style.left ="300";
		  newXgrid.style.top = "0";
		  newXgrid.style.position = "absolute";
		  getCanvas.appendChild(newXgrid);
		  moveXGrid();
	  }
	  
	  	  function createExistingXgrid(topVal) {
		  var getCanvas = document.getElementById("canvasFloat");
		  var newXgrid = document.createElement("div");
		  var gridId = String("canvasGrid"+nextGrid);
		  newXgrid.setAttribute("id", gridId);
		  newXgrid.style.height = "1px";
		  newXgrid.style.width = "2192px";
		  newXgrid.style.cssFloat ="left";
		  newXgrid.style.backgroundColor = "#FF0000";
		  newXgrid.style.left = "303px";
		  newXgrid.style.top = topVal+"px";
		  newXgrid.style.position = "absolute";
		  getCanvas.appendChild(newXgrid);
		  addXGrid();
		  nextGrid++;
	  }
	  
	  function createYgrid() {
		  var getCanvas = document.getElementById("canvasFloat");
		  var newYgrid = document.createElement("div");
		  var gridId = String("canvasGrid"+nextGrid);
		  newYgrid.setAttribute("id", gridId);
		  newYgrid.style.height = "1091px";
		  newYgrid.style.width = "1px";
		  newYgrid.style.cssFloat ="left";
		  newYgrid.style.backgroundColor = "#FF0000";
		  newYgrid.style.left ="300";
		  newYgrid.style.top = "0";
		  newYgrid.style.position = "absolute";
		  getCanvas.appendChild(newYgrid);
		  moveYGrid();
	  }
	  
	  function createExistingYgrid(leftVal) {
		  leftVal = parseInt(leftVal) + 303;
		  var getCanvas = document.getElementById("canvasFloat");
		  var newYgrid = document.createElement("div");
		  var gridId = String("canvasGrid"+nextGrid);
		  newYgrid.setAttribute("id", gridId);
		  newYgrid.style.height = "1091px";
		  newYgrid.style.width = "1px";
		  newYgrid.style.cssFloat ="left";
		  newYgrid.style.backgroundColor = "#FF0000";
		  newYgrid.style.position = "absolute";
		  newYgrid.style.left = leftVal+"px";
		  newYgrid.style.top = "0px";
		  getCanvas.appendChild(newYgrid);
		  addYGrid();
		  nextGrid++;
	  }
	  
	  function moveYGrid() {
		var yGrid = String("#canvasGrid"+nextGrid)
		var runningBoolean = true;
			$("#makeGridCanvas").mousemove(function(e){
				if (runningBoolean) {
				$mouseX = e.pageX;
				$mouseY = e.pageY; 
				$(yGrid).css({left:$mouseX});
				} else {
					return;
				}
		});
		$(yGrid).click(function() {
					snapYGrid();
					runningBoolean = false;
				});
		
	  }
	  function moveXGrid() {
		var xGrid = String("#canvasGrid"+nextGrid)
		var runningBoolean = true;
		
				$("#makeGridCanvas").mousemove(function(e){
					if (runningBoolean) {
					$mouseX = e.pageX;
					$mouseY = e.pageY; 
					$(xGrid).css({top:$mouseY});
					} else {
						return;
					}
				});
				$(xGrid).click(function() {
					snapXGrid();
					runningBoolean = false;
				});
	  }
	  
	  function snapXGrid() {
		  addXGrid();
		  nextGrid++;
		  }
	  
	  function snapYGrid() {
		  addYGrid();
		  nextGrid++;
	  }
	  
	  //Store X value of the Y grid
	  function addYGrid() {
		  var xElementID = String("canvasGrid"+nextGrid);
		  var getXValue = document.getElementById(xElementID).offsetLeft;
		  getXValue -= 303;
		  var storeValue = String(getXValue+",0");
		  gridArray[gridArrayIndex] = storeValue;
		  addGridToList();
		  gridArrayIndex++;
	  }
	  
	  // Store Y value of the X grid
	  function addXGrid() {
		  var yElementID = String("canvasGrid"+nextGrid);
		  var getYValue = document.getElementById(yElementID).offsetTop;
		  var storeValue = String("0,"+getYValue);
		  gridArray[gridArrayIndex] = storeValue;
		  addGridToList();
		  gridArrayIndex++;
	  }
	  
	  function addGridToList() {
		  var parentElement = document.getElementById("createdGridsDisplay");
		  var itemElementID = String("canvasGridList"+nextGrid);
		  var itemElement = document.getElementById(itemElementID);
		  var itemDisplayText = String(gridArray[gridArrayIndex]);
   		  var newList= document.createElement("li");
    	  var newText = document.createTextNode(itemDisplayText);
		  newList.setAttribute("id", itemElementID);
    	  newList.appendChild(newText);
		  newList.innerHTML += " <a href='#' onclick='clearGrid("+nextGrid+")'>Remove this</a>";
   		  parentElement.appendChild(newList);
   		  console.log("element added to list succesfully");
	  }
	  
	  function removeGridFromList(n) {
		  removeItem = String("#canvasGridList"+n);
		  $(removeItem).remove();
		  console.log("successfully removed item "+n+" from the list");
		  gridArray.splice(n,1);
		}
		
		function removeGridsFromList() {
			for (var i = 0; i <= nextGrid; i++) {
		  removeItem = String("#canvasGridList"+i);
		  $(removeItem).remove();
			}
		  console.log("successfully all items from the list");
		  
		}
		
		
		
		function saveGrids() {
				console.log(gridArray);
				writeGridToFile(gridArray);
		}
	  
            function writeGridToFile(data){
				
            var file = String(floorListArray[selectedFloor]);
            var xmlhttp;
            if(window.XMLHttpRequest) {
                xmlhttp=new XMLHttpRequest();
            } else {
                xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
            }

            xmlhttp.open("GET","gridOperations.php?data="+data+"&file="+file,true);
            xmlhttp.send();

			}
	  
	  function clearGrid(n) {
		  removeGrid = String("#canvasGrid"+n);
		  $(removeGrid).remove();
		  removeGridFromList(n);
		  console.log("successfully removed grid number"+n);
		  }
	  
	  function clearGrids() {
		  var removeGridId;
		  var removeGridElement;
		  var parentElement = document.getElementById("canvasFloat");
		  for (var i = 0; i <= nextGrid; i++) {
			  removeGrids = String("#canvasGrid"+i);
			  $(removeGrids).remove();
		  }
		  removeGridsFromList();
		  nextGrid = 0;
		  gridArray.splice(0,gridArray.length);
		  gridArrayIndex = 0;
		  console.log(gridArray);
		  console.log("successfully removed all grids");
	  }
	
	  function loadSelectedFloorGrid(n) {
		  
			jQuery.ajax({
			url: floorListArray[n],
			dataType: 'text',
			type: "GET",
			cache: false,
  			success: function(data) {
    			var newArray = data.split(",");
				for (var i = 0; i<=newArray.length; i++) {
					if (newArray[i] == 0 && newArray[i+1] >= 0) {
						createExistingXgrid(newArray[i+1]);
						console.log("created 1 x grid: "+newArray[i+1]);
					} else if (newArray[i] >= 0 && newArray[i+1] == 0) {
						createExistingYgrid(newArray[i]);
						console.log("created 1 y grid: "+newArray[i]);
					} else {
						console.log("all grids were filled. no further grids were added");
					}
				i++;
				}           
  			}
			});
	  }
		  
	
	  // Check the selected floor, change map and clear grid
	  function checkSelectedFloor() {
		var theCanvas = document.getElementById("makeGridCanvas");
		selectedFloor = parseInt($('input[name="floors"]:checked').val());
		switch (selectedFloor) {
			case 1:
				clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_1etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;
			case 2:
				clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_2etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;
			case 3:
				clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_3etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;
			case 4:
				clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_4etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;
			case 5:
				clearGrids();
				theCanvas.setAttribute("style", "background: url(../kart/kart_KE_5etg.jpg)");
				loadSelectedFloorGrid(selectedFloor);
				break;	
		}
		  
	  }
	  
	  $(document).ready(checkSelectedFloor());
    </script>
        </div>
</div>
</body>
</html>
